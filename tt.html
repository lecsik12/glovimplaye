<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Загрузка аватара с Supabase</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      text-align: center;
    }
    /* Стили для аватара */
    #avatarPreview {
      width: 150px;
      height: 150px;
      border-radius: 50%;
      object-fit: cover;
      border: 2px solid #ddd;
      margin-top: 20px;
      display: inline-block;
    }
    #uploadBtn {
      margin-top: 10px;
      padding: 8px 16px;
      font-size: 16px;
    }
    #status {
      margin-top: 10px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <h1>Загрузка аватара</h1>
  <input type="file" id="fileInput" accept="image/*">
  <br>
  <button id="uploadBtn">Загрузить аватар</button>
  <p id="status"></p>
  <img id="avatarPreview" src="" alt="Аватар">

  <!-- Подключаем библиотеку Supabase -->
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script>
    // Ваши данные из Supabase Dashboard
    const supabaseUrl = 'https://mxfzholwfsbpptfyizfe.supabase.co';
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im14Znpob2x3ZnNicHB0ZnlpemZlIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Mzg1OTkxMDksImV4cCI6MjA1NDE3NTEwOX0.SOOnGEvNL8mZTlR9NbbwXrNvwrqi1x4ImGVk8ojrsiw';
    
    // Создаем клиент Supabase с новым именем переменной
    const supabaseClient = supabase.createClient(supabaseUrl, supabaseKey);

    const fileInput = document.getElementById('fileInput');
    const uploadBtn = document.getElementById('uploadBtn');
    const statusEl = document.getElementById('status');
    const avatarPreview = document.getElementById('avatarPreview');

    uploadBtn.addEventListener('click', async () => {
      const file = fileInput.files[0];
      if (!file) {
        statusEl.textContent = 'Пожалуйста, выберите изображение для загрузки.';
        return;
      }
      
      statusEl.textContent = 'Загрузка...';

      // Укажите имя bucket-а, который существует в Supabase (например, "avatars")
      const bucketName = 'avatars';
      // Генерируем уникальное имя файла
      const filePath = `${Date.now()}_${file.name}`;
      
      console.log('Попытка загрузить файл: ', file);
      console.log('Bucket:', bucketName, 'File path:', filePath);

      // Загружаем файл в Supabase Storage
      const { data, error } = await supabaseClient.storage
        .from(bucketName)
        .upload(filePath, file);

      if (error) {
        console.error('Ошибка загрузки:', error);
        statusEl.textContent = 'Ошибка загрузки: ' + JSON.stringify(error);
        return;
      }

      console.log('Данные после загрузки:', data);

      // Получаем публичный URL загруженного файла
      const { data: publicData } = supabaseClient.storage
        .from(bucketName)
        .getPublicUrl(filePath);
      
      console.log('Данные публичного URL:', publicData);

      if (publicData && publicData.publicUrl) {
        statusEl.textContent = 'Аватар успешно загружен!';
        avatarPreview.src = publicData.publicUrl;
        console.log('Публичный URL:', publicData.publicUrl);
      } else {
        statusEl.textContent = 'Не удалось получить публичный URL.';
      }
    });
  </script>
</body>
</html>
