<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>Оформление заказа | GlovimPlaye</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <!-- Font Awesome для иконок -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
  
  <!-- Общие стили -->
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: Arial, sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    header {
      background: #333;
      color: #fff;
      padding: 15px;
      text-align: center;
      margin-bottom: 20px;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      overflow: hidden;
      display: flex;
      flex-wrap: wrap;
    }
    .product-details,
    .checkout-section {
      padding: 20px;
      flex: 1 1 400px;
    }
    .product-details {
      border-right: 1px solid #eee;
    }
    .product-details h2,
    .checkout-section h2 {
      margin-top: 0;
      color: #ff7f50;
    }
    .product-img {
      width: 100%;
      max-height: 300px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    .seller-info {
      display: flex;
      align-items: center;
      margin-top: 15px;
    }
    .seller-info a {
      text-decoration: none;
      color: inherit;
      display: flex;
      align-items: center;
    }
    .seller-info img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      margin-right: 10px;
      border: 2px solid #ff7f50;
    }
    .order-summary {
      margin-top: 20px;
    }
    .order-summary p {
      font-size: 16px;
      margin: 5px 0;
    }
    .reviews-section {
      margin-top: 30px;
    }
    .reviews-section h3 {
      margin-bottom: 10px;
      color: #555;
    }
    .review-item {
      border-bottom: 1px solid #eee;
      padding: 10px 0;
    }
    .review-item:last-child {
      border-bottom: none;
    }
    .review-item strong {
      color: #ff7f50;
    }
    .checkout-form label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    .checkout-form input, 
    .checkout-form textarea, 
    .checkout-form select {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .checkout-btn, .review-btn {
      background: #ff7f50;
      color: #fff;
      border: none;
      padding: 12px 25px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 15px;
      transition: background 0.3s;
    }
    .checkout-btn:hover, .review-btn:hover {
      background: #ff4500;
    }
    .payment-note {
      font-size: 14px;
      color: #666;
      margin-top: 15px;
      line-height: 1.4;
    }
    /* Нижняя навигация (только на мобильных) */
    .bottom-nav {
      display: none;
    }
    @media(max-width: 768px) {
      .container {
        flex-direction: column;
      }
      .product-details {
        border-right: none;
        border-bottom: 1px solid #eee;
      }
      .bottom-nav {
        display: flex;
        position: fixed;
        bottom: 0;
        width: 100%;
        background: #333;
        padding: 12px 0;
        justify-content: space-around;
        color: #fff;
      }
    }
  </style>
</head>
<body>

<div class="container">
  <!-- Левая колонка: Информация о товаре, продавце и отзывы -->
  <div class="product-details">
    <h2>Детали товара</h2>
    <img id="productImg" class="product-img" src="placeholder.jpg" alt="Изображение товара">
    <h3 id="productName">Название товара</h3>
    <p id="productDescription">Описание товара...</p>
    <p><strong>Цена:</strong> <span id="productPrice">0</span> ₽</p>
    <!-- Ссылка на профиль продавца. Изначально href оставлен пустым – будет обновлён скриптом -->
    <div class="seller-info">
      <a href="" id="sellerProfileLink">
        <img id="sellerAvatar" src="default-avatar.png" alt="Продавец">
        <div>
          <p><strong>Продавец:</strong> <span id="sellerName">Неизвестно</span></p>
        </div>
      </a>
    </div>
    <div class="order-summary">
      <p><strong>Итого к оплате:</strong> <span id="orderTotal">0</span> ₽</p>
    </div>
    <!-- Блок отзывов о продавце -->
    <div class="reviews-section">
      <h3>Отзывы о продавце</h3>
      <div id="reviewsList">
        <p>Нет отзывов.</p>
      </div>
    </div>
  </div>
  
  <!-- Правая колонка: Оформление заказа с выбором способа оплаты -->
  <div class="checkout-section">
    <h2>Оформление заказа</h2>
    <form id="checkoutForm" class="checkout-form">
      <!-- Поле для адреса доставки (если необходимо) -->
      <label for="address">Адрес доставки:</label>
      <textarea id="address" rows="2" placeholder="Введите адрес доставки"></textarea>
      
      <!-- Секция выбора способа оплаты -->
      <label for="paymentMethod">Способ оплаты:</label>
      <select id="paymentMethod">
        <option value="crypto">Криптовалюта</option>
        <option value="card-ukr">Карта (Украина)</option>
        <option value="card-rus">Карта (Россия)</option>
        <option value="balance">С баланса</option>
      </select>
      <p class="payment-note">Выберите удобный способ оплаты. После успешного платежа вы будете перенаправлены в чат с продавцом.</p>
      
      <!-- Кнопка оформить заказ -->
      <button type="submit" class="checkout-btn">Купить</button>
    </form>
  </div>
</div>

<!-- Нижняя навигация для мобильных -->
<div class="bottom-nav">
  <a href="index.html"><i class="fas fa-home"></i><span>Главная</span></a>
  <a href="add.html"><i class="fas fa-plus"></i><span>Продать</span></a>
  <a href="chat.html"><i class="fas fa-comments"></i><span>Чат</span></a>
  <a href="profile.html"><img class="avatar" src="default-avatar.png" alt="Аватар" style="width:24px; height:24px; border-radius:50%;"><i class="fas fa-user"></i><span>Профиль</span></a>
</div>

<script>
  // Firebase конфигурация (замените на свои данные)
  var firebaseConfig = {
    apiKey: "AIzaSyAhn2H2BExFFf7GO2k_YDfrwPiV_cYdUBg",
    authDomain: "glovimplaye-b1023.firebaseapp.com",
    databaseURL: "https://glovimplaye-b1023-default-rtdb.firebaseio.com",
    projectId: "glovimplaye-b1023",
    storageBucket: "glovimplaye-b1023.firebasestorage.app",
    messagingSenderId: "553440591519",
    appId: "1:553440591519:web:b7be45a9253689f322acaa"
  };
  firebase.initializeApp(firebaseConfig);
  
  // Функция получения GET-параметров
  function getParameterByName(name, url = window.location.href) {
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  }
  
  // Проверка авторизации (покупатель)
  firebase.auth().onAuthStateChanged(function(user) {
    if (!user) {
      window.location.href = "login.html";
    }
  });
  
  // Получаем id товара из URL (например, ?id=PRODUCT_ID)
  const productId = getParameterByName('id');
  if (!productId) {
    alert("Товар не найден!");
    window.location.href = "index.html";
  }
  
  // Загрузка данных товара из Firebase
  let currentSeller = "";
  firebase.database().ref('products/' + productId).once('value').then(snapshot => {
    if (!snapshot.exists()) {
      alert("Товар не найден!");
      window.location.href = "index.html";
      return;
    }
    const product = snapshot.val();
    document.getElementById("productName").innerText = product.name;
    document.getElementById("productDescription").innerText = product.description || "Описание отсутствует";
    document.getElementById("productPrice").innerText = product.price;
    document.getElementById("orderTotal").innerText = product.price;
    if (product.image) {
      document.getElementById("productImg").src = product.image;
    }
    
    // Сохраняем id продавца из данных товара
    currentSeller = product.sellerId;
    
    // Загружаем данные продавца по sellerId, чтобы отобразить ник из профиля
    firebase.database().ref('users/' + currentSeller).once('value').then(snapshot => {
      const sellerData = snapshot.val();
      if (sellerData && sellerData.nickname) {
        document.getElementById("sellerName").innerText = sellerData.nickname;
      } else {
        document.getElementById("sellerName").innerText = product.sellerName || "Неизвестно";
      }
      document.getElementById("sellerAvatar").src = (sellerData && sellerData.avatar) ? sellerData.avatar : "default-avatar.png";
    });
    
    // Обновляем ссылку на профиль продавца с правильным uid
    document.getElementById("sellerProfileLink").href = "seller.html?uid=" + currentSeller;
    
    // Загружаем отзывы для продавца
    loadSellerReviews(currentSeller);
  }).catch(error => {
    console.error("Ошибка получения товара:", error);
  });
  
  // Загрузка отзывов для продавца (по sellerId)
  function loadSellerReviews(sellerId) {
    const reviewsRef = firebase.database().ref('reviews/' + sellerId);
    reviewsRef.on('value', snapshot => {
      const reviewsList = document.getElementById("reviewsList");
      if(reviewsList) {
        reviewsList.innerHTML = "";
        if (!snapshot.exists()) {
          reviewsList.innerHTML = "<p>Нет отзывов.</p>";
          return;
        }
        snapshot.forEach(childSnapshot => {
          const review = childSnapshot.val();
          const reviewDiv = document.createElement("div");
          reviewDiv.className = "review-item";
          reviewDiv.innerHTML = `<strong>${review.buyerName}:</strong> ${review.text}`;
          reviewsList.appendChild(reviewDiv);
        });
      }
    });
  }
  
  // Обработка оформления заказа
  const checkoutForm = document.getElementById("checkoutForm");
  checkoutForm.addEventListener("submit", function(e) {
    e.preventDefault();
    
    // Симуляция обработки платежа с выбранным способом
    const paymentMethod = document.getElementById("paymentMethod").value;
    processPayment(paymentMethod)
      .then(() => {
        // После успешной оплаты оформляем заказ
        const orderData = {
          productId: productId,
          productName: document.getElementById("productName").innerText,
          productPrice: document.getElementById("productPrice").innerText,
          sellerName: document.getElementById("sellerName").innerText,
          buyerId: firebase.auth().currentUser.uid,
          address: document.getElementById("address").value,
          paymentMethod: paymentMethod,
          quantity: 1,
          createdAt: firebase.database.ServerValue.TIMESTAMP
        };
        
        firebase.database().ref('orders').push(orderData, function(error) {
          if (error) {
            alert("Ошибка оформления заказа: " + error.message);
          } else {
            alert("Заказ успешно оформлен!");
            // Перенаправление в чат с продавцом
            window.location.href = "chat.html?seller=" + currentSeller;
          }
        });
      })
      .catch(error => {
        alert("Платеж не выполнен: " + error);
      });
  });
  
  // Фейковая функция обработки платежа
  function processPayment(method) {
    return new Promise((resolve, reject) => {
      console.log("Обработка платежа методом:", method);
      setTimeout(() => {
        resolve();
      }, 2000);
    });
  }
</script>

</body>
</html>
