<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <title>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ | GlovimPlaye</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <!-- Firebase v8 -->
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
  
  <!-- Font Awesome –¥–ª—è –∏–∫–æ–Ω–æ–∫ -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.1/css/all.min.css">
  
  <!-- –û–±—â–∏–µ —Å—Ç–∏–ª–∏ -->
  <style>
    * { box-sizing: border-box; }
    body {
      font-family: 'Arial', sans-serif;
      background: #f7f7f7;
      margin: 0;
      padding: 20px;
      color: #333;
    }
    header {
      background: #333;
      color: #fff;
      padding: 15px;
      text-align: center;
      margin-bottom: 20px;
    }
    .container {
      max-width: 960px;
      margin: 0 auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.1);
      overflow: hidden;
      display: flex;
      flex-wrap: wrap;
    }
    .product-details, .buyer-details {
      padding: 20px;
      flex: 1 1 400px;
    }
    .product-details {
      border-right: 1px solid #eee;
    }
    .product-details h2, .buyer-details h2 {
      margin-top: 0;
      color: #ff7f50;
    }
    .product-img {
      width: 100%;
      max-height: 300px;
      object-fit: cover;
      border-radius: 4px;
      margin-bottom: 15px;
    }
    .seller-info {
      display: flex;
      align-items: center;
      margin-top: 15px;
    }
    .seller-info img {
      width: 50px;
      height: 50px;
      border-radius: 50%;
      margin-right: 10px;
      border: 2px solid #ff7f50;
    }
    .order-summary {
      margin-top: 20px;
    }
    .order-summary p {
      font-size: 16px;
      margin: 5px 0;
    }
    .reviews-section {
      margin-top: 30px;
    }
    .reviews-section h3 {
      margin-bottom: 10px;
      color: #555;
    }
    .review-item {
      border-bottom: 1px solid #eee;
      padding: 10px 0;
    }
    .review-item:last-child {
      border-bottom: none;
    }
    .review-item strong {
      color: #ff7f50;
    }
    .buyer-info {
      border: 1px solid #eee;
      padding: 15px;
      border-radius: 4px;
      margin-bottom: 20px;
      text-align: center;
    }
    .buyer-info img {
      width: 80px;
      height: 80px;
      border-radius: 50%;
      border: 2px solid #ff7f50;
      margin-bottom: 10px;
    }
    .checkout-form label {
      display: block;
      margin-top: 10px;
      font-weight: bold;
    }
    .checkout-form input, .checkout-form textarea {
      width: 100%;
      padding: 10px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }
    .checkout-btn, .review-btn {
      background: #ff7f50;
      color: #fff;
      border: none;
      padding: 12px 25px;
      border-radius: 4px;
      cursor: pointer;
      font-size: 16px;
      margin-top: 15px;
      transition: background 0.3s;
    }
    .checkout-btn:hover, .review-btn:hover {
      background: #ff4500;
    }
    .review-form {
      margin-top: 20px;
    }
    /* –°–µ–∫—Ü–∏—è —Å–ø–æ—Å–æ–±–∞ –æ–ø–ª–∞—Ç—ã –∏ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ */
    .payment-section {
      margin-top: 15px;
    }
    .payment-section label {
      display: block;
      font-weight: bold;
      margin-top: 10px;
    }
    .payment-section select {
      width: 100%;
      max-width: 300px;
      padding: 8px;
      margin-top: 5px;
    }
    .payment-section .price-from {
      display: inline-block;
      margin-top: 5px;
      color: #666;
      font-size: 14px;
    }
    .quantity-section {
      margin-top: 15px;
    }
    .quantity-section a {
      color: #007bff;
      text-decoration: none;
      font-size: 14px;
    }
    .quantity-section a:hover {
      text-decoration: underline;
    }
    .quantity-wrapper {
      display: none;
      margin-top: 10px;
    }
    .quantity-wrapper label {
      font-weight: bold;
    }
    .quantity-wrapper input[type="number"] {
      width: 80px;
      padding: 5px;
      margin-left: 5px;
    }
    .payment-note {
      font-size: 14px;
      color: #666;
      margin-top: 15px;
      line-height: 1.4;
    }
    
    @media(max-width: 768px) {
      .container {
        flex-direction: column;
      }
      .product-details {
        border-right: none;
        border-bottom: 1px solid #eee;
      }
    }
  </style>
</head>
<body>

<header>
  <h1>–û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞</h1>
</header>

<div class="container">
  <!-- –õ–µ–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–æ–≤–∞—Ä–µ, –ø—Ä–æ–¥–∞–≤—Ü–µ –∏ –æ—Ç–∑—ã–≤—ã -->
  <div class="product-details">
    <h2>–î–µ—Ç–∞–ª–∏ —Ç–æ–≤–∞—Ä–∞</h2>
    <img id="productImg" class="product-img" src="placeholder.jpg" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
    <h3 id="productName">–ù–∞–∑–≤–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞</h3>
    <p id="productDescription">–û–ø–∏—Å–∞–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞...</p>
    <p><strong>–¶–µ–Ω–∞:</strong> <span id="productPrice">0</span> ‚ÇΩ</p>
    <div class="seller-info">
      <img id="sellerAvatar" src="default-avatar.png" alt="–ü—Ä–æ–¥–∞–≤–µ—Ü">
      <div>
        <p><strong>–ü—Ä–æ–¥–∞–≤–µ—Ü:</strong> <span id="sellerName">–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ</span></p>
      </div>
    </div>
    <div class="order-summary">
      <p><strong>–ò—Ç–æ–≥–æ –∫ –æ–ø–ª–∞—Ç–µ:</strong> <span id="orderTotal">0</span> ‚ÇΩ</p>
    </div>
    <!-- –ë–ª–æ–∫ –æ—Ç–∑—ã–≤–æ–≤ –æ –ø—Ä–æ–¥–∞–≤—Ü–µ -->
    <div class="reviews-section">
      <h3>–û—Ç–∑—ã–≤—ã –æ –ø—Ä–æ–¥–∞–≤—Ü–µ</h3>
      <div id="reviewsList">
        <p>–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤.</p>
      </div>
    </div>
  </div>
  
  <!-- –ü—Ä–∞–≤–∞—è –∫–æ–ª–æ–Ω–∫–∞: –î–∞–Ω–Ω—ã–µ –ø–æ–∫—É–ø–∞—Ç–µ–ª—è, –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∑–∞–∫–∞–∑–∞ –∏ –æ—Ç–∑—ã–≤ -->
  <div class="buyer-details">
    <h2>–í–∞—à–∏ –¥–∞–Ω–Ω—ã–µ</h2>
    <div class="buyer-info">
      <img id="buyerAvatar" src="default-avatar.png" alt="–í–∞—à –∞–≤–∞—Ç–∞—Ä">
      <p><strong id="buyerName">–í–∞—à–µ –∏–º—è</strong></p>
      <a href="seller.html?uid=–ü–†–û–î–ê–í–ï–¶_UID"></a>
    </div>
    <form id="checkoutForm" class="checkout-form">
      <label for="address">–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏:</label>
      <textarea id="address" rows="3" required placeholder="–í–≤–µ–¥–∏—Ç–µ –∞–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏"></textarea>
      

      
      <div class="payment-section">
        <label for="paymentMethod">–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã:</label>
        <select id="paymentMethod" name="paymentMethod">
          <option value="">–ù–µ –≤—ã–±—Ä–∞–Ω</option>
          <option value="bankCard">–ë–∞–Ω–∫–æ–≤—Å–∫–∞—è –∫–∞—Ä—Ç–∞</option>
          <option value="qiwi">Qiwi</option>
          <option value="yoomoney">–ÆMoney</option>
        </select>
        <span class="price-from">–æ—Ç <span id="priceFrom">350</span> ‚ÇΩ</span>
      </div>
      
      <div class="quantity-section">
        <a href="#" id="buyMultipleLink">–ö—É–ø–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —à—Ç—É–∫</a>
        <div class="quantity-wrapper" id="quantityWrapper">
          <label for="quantity">–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ:</label>
          <input type="number" id="quantity" min="1" value="1">
        </div>
      </div>
      
      <button type="submit" class="checkout-btn" id="buyBtn">–ö—É–ø–∏—Ç—å</button>
      <p class="payment-note">
        –ü—Ä–æ–¥–∞–≤–µ—Ü –Ω–µ –ø–æ–ª—É—á–∏—Ç –æ–ø–ª–∞—Ç—É, –ø–æ–∫–∞ –Ω–µ –ø–æ–¥—Ç–≤–µ—Ä–¥–∏—Ç–µ –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –æ–±—è–∑–∞—Ç–µ–ª—å—Å—Ç–≤.
      </p>
    </form>
    
    <!-- –ë–ª–æ–∫ —Ä–µ–π—Ç–∏–Ω–≥–∞ –∏ –æ—Ç–∑—ã–≤–æ–≤ (–ø–æ—è–≤–ª—è–µ—Ç—Å—è –ø–æ—Å–ª–µ —É—Å–ø–µ—à–Ω–æ–≥–æ –∑–∞–∫–∞–∑–∞) -->
    <div class="reviews-section" id="reviewSection" style="display:none;">
      <h3>–†–µ–π—Ç–∏–Ω–≥ –ø—Ä–æ–¥–∞–≤—Ü–∞: <span id="ratingPercent">0%</span></h3>
      <div class="rating-buttons">
        <button id="likeBtn">üëç –õ–∞–π–∫</button>
        <button id="dislikeBtn">üëé –î–∏–∑–ª–∞–π–∫</button>
      </div>
      <div class="review-form">
        <form id="reviewForm">
          <label for="reviewText">–û—Å—Ç–∞–≤—å—Ç–µ –æ—Ç–∑—ã–≤:</label>
          <textarea id="reviewText" rows="3" placeholder="–ù–∞–ø–∏—à–∏—Ç–µ –≤–∞—à –æ—Ç–∑—ã–≤..."></textarea>
          <button type="submit" class="review-btn">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –æ—Ç–∑—ã–≤</button>
        </form>
      </div>
    </div>
  </div>
</div>

<!-- –ù–∏–∂–Ω—è—è –Ω–∞–≤–∏–≥–∞—Ü–∏—è –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö -->
<div class="bottom-nav" style="position:fixed; bottom:0; width:100%; background:#333; padding:12px 0; display:flex; justify-content:space-around; color:#fff;">
  <a href="index.html" style="text-decoration:none; color:#fff;"><i class="fas fa-home"></i><span>–ì–ª–∞–≤–Ω–∞—è</span></a>
  <a href="add.html" style="text-decoration:none; color:#fff;"><i class="fas fa-plus"></i><span>–ü—Ä–æ–¥–∞—Ç—å</span></a>
  <a href="chat.html" style="text-decoration:none; color:#fff;"><i class="fas fa-comments"></i><span>–ß–∞—Ç</span></a>
  <a href="profile.html" style="text-decoration:none; color:#fff;"><img class="avatar" src="default-avatar.png" alt="–ê–≤–∞—Ç–∞—Ä" style="width:24px; height:24px; border-radius:50%;"><i class="fas fa-user"></i><span>–ü—Ä–æ—Ñ–∏–ª—å</span></a>
</div>

<script>
  // Firebase –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è (–∑–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ)
  var firebaseConfig = {
    apiKey: "AIzaSyAhn2H2BExFFf7GO2k_YDfrwPiV_cYdUBg",
    authDomain: "glovimplaye-b1023.firebaseapp.com",
    databaseURL: "https://glovimplaye-b1023-default-rtdb.firebaseio.com",
    projectId: "glovimplaye-b1023",
    storageBucket: "glovimplaye-b1023.firebasestorage.app",
    messagingSenderId: "553440591519",
    appId: "1:553440591519:web:b7be45a9253689f322acaa"
  };
  firebase.initializeApp(firebaseConfig);
  
  // –ü–æ–ª—É—á–∞–µ–º –ø–∞—Ä–∞–º–µ—Ç—Ä—ã URL (–Ω–∞–ø—Ä–∏–º–µ—Ä, id —Ç–æ–≤–∞—Ä–∞)
  function getParameterByName(name, url = window.location.href) {
    name = name.replace(/[\[\]]/g, '\\$&');
    var regex = new RegExp('[?&]' + name + '(=([^&#]*)|&|#|$)'),
        results = regex.exec(url);
    if (!results) return null;
    if (!results[2]) return '';
    return decodeURIComponent(results[2].replace(/\+/g, ' '));
  }
  
  // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
  firebase.auth().onAuthStateChanged(function(user) {
    if (user) {
      loadUserProfile(user);
      loadUserProducts(user.uid);
      loadUserReviews(user.uid);
    } else {
      window.location.href = "login.html";
    }
  });
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
  function loadUserProfile(user) {
    firebase.database().ref('users/' + user.uid).once('value').then(snapshot => {
      const data = snapshot.val();
      if (data) {
        document.getElementById("buyerName").innerText = data.nickname || "–ë–µ–∑ –Ω–∏–∫–∞";
        document.getElementById("buyerAvatar").src = data.avatar || user.photoURL || "default-avatar.png";
      }
    });
  }
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ —Ç–æ–≤–∞—Ä–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, –¥–ª—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–æ—Ñ–∏–ª—è —Å –æ—Ç–∑—ã–≤–∞–º–∏ –∏ —Ç–æ–≤–∞—Ä–∞–º–∏)
  function loadUserProducts(userId) {
    const productsRef = firebase.database().ref('products');
    productsRef.orderByChild('sellerId').equalTo(userId).on('value', snapshot => {
      const productsList = document.getElementById("productsList");
      if(productsList) {
        productsList.innerHTML = "";
        if (!snapshot.exists()) {
          productsList.innerHTML = "<p>–¢–æ–≤–∞—Ä–æ–≤ –Ω–µ—Ç.</p>";
          return;
        }
        snapshot.forEach(childSnapshot => {
          const product = childSnapshot.val();
          const card = document.createElement("div");
          card.className = "product-card";
          card.innerHTML = `
            <img src="${product.image || 'placeholder.jpg'}" alt="–ò–∑–æ–±—Ä–∞–∂–µ–Ω–∏–µ —Ç–æ–≤–∞—Ä–∞">
            <h3>${product.name}</h3>
            <p>${product.price} ‚ÇΩ</p>
          `;
          productsList.appendChild(card);
        });
      }
    });
  }
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ –æ—Ç–∑—ã–≤–æ–≤ –¥–ª—è –ø—Ä–æ–¥–∞–≤—Ü–∞ (–æ—Ç–∑—ã–≤—ã —Ö—Ä–∞–Ω—è—Ç—Å—è –ø–æ uid –ø—Ä–æ–¥–∞–≤—Ü–∞)
  function loadUserReviews(userId) {
    const reviewsRef = firebase.database().ref('reviews/' + userId);
    reviewsRef.on('value', snapshot => {
      const reviewsList = document.getElementById("reviewsList");
      if(reviewsList) {
        reviewsList.innerHTML = "";
        if (!snapshot.exists()) {
          reviewsList.innerHTML = "<p>–ù–µ—Ç –æ—Ç–∑—ã–≤–æ–≤.</p>";
          return;
        }
        snapshot.forEach(childSnapshot => {
          const review = childSnapshot.val();
          const reviewDiv = document.createElement("div");
          reviewDiv.className = "review-item";
          reviewDiv.innerHTML = `<strong>${review.buyerName}:</strong> ${review.text}`;
          reviewsList.appendChild(reviewDiv);
        });
      }
    });
  }
  
  // –§—É–Ω–∫—Ü–∏—è –æ—Ç–ø—Ä–∞–≤–∫–∏ –∑–∞–∫–∞–∑–∞ –≤ Telegram —á–µ—Ä–µ–∑ Cryptobot
  function sendOrderToTelegram(orderData) {
    const botToken = "357860:AA6gJoYF..."; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π —Ç–æ–∫–µ–Ω
    const chatId = "YOUR_CHAT_ID"; // –ó–∞–º–µ–Ω–∏—Ç–µ –Ω–∞ –∞–∫—Ç—É–∞–ª—å–Ω—ã–π ID —á–∞—Ç–∞
    const message = `–ù–æ–≤—ã–π –∑–∞–∫–∞–∑:
–¢–æ–≤–∞—Ä: ${orderData.productName}
–¶–µ–Ω–∞: ${orderData.productPrice} ‚ÇΩ
–ü—Ä–æ–¥–∞–≤–µ—Ü: ${orderData.sellerName}
–ü–æ–∫—É–ø–∞—Ç–µ–ª—å: ${orderData.buyer.displayName}
–ê–¥—Ä–µ—Å –¥–æ—Å—Ç–∞–≤–∫–∏: ${orderData.address}
–°–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã: ${orderData.paymentMethod}
–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ: ${orderData.quantity}`;
    
    const telegramUrl = `https://api.telegram.org/bot${botToken}/sendMessage?chat_id=${chatId}&text=${encodeURIComponent(message)}`;
    
    fetch(telegramUrl)
      .then(response => response.json())
      .then(data => {
        console.log("–°–æ–æ–±—â–µ–Ω–∏–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ –≤ Telegram:", data);
      })
      .catch(error => {
        console.error("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Telegram:", error);
      });
  }
  
  // –ü–æ–ª—É—á–∞–µ–º id —Ç–æ–≤–∞—Ä–∞ –∏–∑ URL
  const productId = getParameterByName('id');
  if (!productId) {
    alert("–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!");
    window.location.href = "index.html";
  }
  
  // –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö —Ç–æ–≤–∞—Ä–∞ –∏–∑ Firebase
  let currentSeller = "";
  firebase.database().ref('products/' + productId).once('value').then(snapshot => {
    if (!snapshot.exists()) {
      alert("–¢–æ–≤–∞—Ä –Ω–µ –Ω–∞–π–¥–µ–Ω!");
      window.location.href = "index.html";
      return;
    }
    const product = snapshot.val();
    document.getElementById("productName").innerText = product.name;
    document.getElementById("productDescription").innerText = product.description || "–û–ø–∏—Å–∞–Ω–∏–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç";
    document.getElementById("productPrice").innerText = product.price;
    document.getElementById("orderTotal").innerText = product.price;
    if (product.image) {
      document.getElementById("productImg").src = product.image;
    }
    document.getElementById("sellerName").innerText = product.sellerName || "–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ";
    document.getElementById("sellerAvatar").src = product.sellerAvatar || "default-avatar.png";
    currentSeller = product.sellerId; // –ø—Ä–µ–¥–ø–æ–ª–∞–≥–∞–µ—Ç—Å—è, —á—Ç–æ sellerId —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É–µ—Ç uid –ø—Ä–æ–¥–∞–≤—Ü–∞
    loadUserReviews(currentSeller);
  }).catch(error => {
    console.error("–û—à–∏–±–∫–∞ –ø–æ–ª—É—á–µ–Ω–∏—è —Ç–æ–≤–∞—Ä–∞:", error);
  });
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –∫–ª–∏–∫–∞ –ø–æ —Å—Å—ã–ª–∫–µ "–ö—É–ø–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ —à—Ç—É–∫"
  const buyMultipleLink = document.getElementById('buyMultipleLink');
  const quantityWrapper = document.getElementById('quantityWrapper');
  buyMultipleLink.addEventListener('click', function(e) {
    e.preventDefault();
    quantityWrapper.style.display = (quantityWrapper.style.display === 'block') ? 'none' : 'block';
  });
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞ (submit —Ñ–æ—Ä–º—ã)
  const checkoutForm = document.getElementById("checkoutForm");
  checkoutForm.addEventListener("submit", function(e) {
    e.preventDefault();
    
    const currentUser = JSON.parse(localStorage.getItem("user"));
    if (!currentUser) {
      alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞.");
      return;
    }
    
    const paymentMethod = document.getElementById("paymentMethod").value;
    const quantity = parseInt(document.getElementById("quantity").value || "1");
    if (!paymentMethod) {
      alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤—ã–±–µ—Ä–∏—Ç–µ —Å–ø–æ—Å–æ–± –æ–ø–ª–∞—Ç—ã.");
      return;
    }
    if (quantity < 1) {
      alert("–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –º–µ–Ω—å—à–µ 1.");
      return;
    }
    
    const orderData = {
      productId: productId,
      productName: document.getElementById("productName").innerText,
      productPrice: document.getElementById("productPrice").innerText,
      sellerName: document.getElementById("sellerName").innerText,
      buyer: currentUser,
      address: document.getElementById("address").value,
      paymentMethod: paymentMethod,
      quantity: quantity,
      createdAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    firebase.database().ref('orders').push(orderData, function(error) {
      if (error) {
        alert("–û—à–∏–±–∫–∞ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è –∑–∞–∫–∞–∑–∞: " + error.message);
      } else {
        alert("–ó–∞–∫–∞–∑ —É—Å–ø–µ—à–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω!");
        sendOrderToTelegram(orderData);
        // –°–∫—Ä—ã–≤–∞–µ–º —Ñ–æ—Ä–º—É –∑–∞–∫–∞–∑–∞ –∏ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º –±–ª–æ–∫ –æ—Ç–∑—ã–≤–æ–≤/—Ä–µ–π—Ç–∏–Ω–≥–∞
        document.getElementById("checkoutForm").style.display = "none";
        document.getElementById("reviewSection").style.display = "block";
      }
    });
  });
  
  // –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–∑—ã–≤–∞
  const reviewForm = document.getElementById("reviewForm");
  reviewForm.addEventListener("submit", function(e) {
    e.preventDefault();
    
    const currentUser = JSON.parse(localStorage.getItem("user"));
    if (!currentUser) {
      alert("–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É –¥–ª—è –æ—Å—Ç–∞–≤–ª–µ–Ω–∏—è –æ—Ç–∑—ã–≤–∞.");
      return;
    }
    
    const reviewText = document.getElementById("reviewText").value;
    if (!reviewText.trim()) {
      alert("–û—Ç–∑—ã–≤ –Ω–µ –º–æ–∂–µ—Ç –±—ã—Ç—å –ø—É—Å—Ç—ã–º.");
      return;
    }
    
    const reviewData = {
      buyerName: currentUser.displayName,
      text: reviewText,
      createdAt: firebase.database.ServerValue.TIMESTAMP
    };
    
    firebase.database().ref('reviews/' + currentSeller).push(reviewData, function(error) {
      if (error) {
        alert("–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –æ—Ç–∑—ã–≤–∞: " + error.message);
      } else {
        alert("–û—Ç–∑—ã–≤ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω!");
        reviewForm.reset();
      }
    });
  });
  
  // –§—É–Ω–∫—Ü–∏–∏ –¥–ª—è —Ä–µ–π—Ç–∏–Ω–≥–∞ (–ª–∞–π–∫–∏/–¥–∏–∑–ª–∞–π–∫–∏)
  function loadRating() {
    firebase.database().ref('reviews/' + currentSeller).once('value').then(snapshot => {
      let data = snapshot.val();
      let likes = data?.likes || 0;
      let dislikes = data?.dislikes || 0;
      let total = likes + dislikes;
      let ratingPercent = total > 0 ? Math.round((likes / total) * 100) : 0;
      document.getElementById("ratingPercent").innerText = ratingPercent + "%";
    });
  }
  
  function sendReview(type) {
    firebase.database().ref('reviews/' + currentSeller).once('value').then(snapshot => {
      let data = snapshot.val() || { likes: 0, dislikes: 0 };
      if (type === "like") {
        data.likes += 1;
      } else {
        data.dislikes += 1;
      }
      firebase.database().ref('reviews/' + currentSeller).set(data, error => {
        if (!error) {
          alert("–°–ø–∞—Å–∏–±–æ –∑–∞ –≤–∞—à—É –æ—Ü–µ–Ω–∫—É!");
          document.getElementById("likeBtn").disabled = true;
          document.getElementById("dislikeBtn").disabled = true;
          loadRating();
        }
      });
    });
  }
  
  document.getElementById("likeBtn").addEventListener("click", () => sendReview("like"));
  document.getElementById("dislikeBtn").addEventListener("click", () => sendReview("dislike"));
  loadRating();
</script>

</body>
</html>
